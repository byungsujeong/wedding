<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>정병수 & 김선아 결혼예배</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <style>
    * {
      box-sizing: border-box;
    }
    
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow-x: hidden;
      background-color: #f8f9fa;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    #pdf-container {
      width: 100vw;
      max-width: 100vw;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      background-color: #f8f9fa;
      padding: 0;
    }
    
    .page-container {
      position: relative;
      margin: 0;
      padding: 0;
      width: 100vw;
      max-width: 100vw;
      background-color: #fff;
      overflow: hidden;
      border-bottom: 1px solid #e9ecef;
    }
    
    /* 페이지 간 여백 완전 제거 */
    .page-container + .page-container {
      margin-top: 0;
      border-top: none;
    }
    
    /* 첫 번째와 마지막 페이지의 경계선 제거 */
    .page-container:first-child {
      border-top: none;
    }
    
    .page-container:last-child {
      border-bottom: none;
    }
    
    canvas {
      display: block;
      width: 100vw !important;
      max-width: 100vw !important;
      height: auto !important;
      margin: 0;
      padding: 0;
      vertical-align: top;
    }
    
    .textLayer {
      position: absolute;
      left: 0;
      top: 0;
      right: 0;
      bottom: 0;
      overflow: hidden;
      line-height: 1.0;
      pointer-events: auto;
      user-select: text !important;
      -webkit-user-select: text !important;
      -moz-user-select: text !important;
      -ms-user-select: text !important;
      z-index: 5;
    }
    
    .textLayer > span {
      color: transparent;
      position: absolute;
      white-space: pre;
      cursor: text;
      transform-origin: 0% 0%;
      user-select: text !important;
      -webkit-user-select: text !important;
      -moz-user-select: text !important;
      -ms-user-select: text !important;
      pointer-events: auto;
    }
    
    .textLayer ::selection {
      background: rgba(0, 100, 255, 0.3);
    }
    
    .textLayer ::-moz-selection {
      background: rgba(0, 100, 255, 0.3);
    }
    
    .linkLayer {
      position: absolute;
      left: 0;
      top: 0;
      right: 0;
      bottom: 0;
      overflow: hidden;
      pointer-events: auto;
      z-index: 10;
    }
    
    .linkLayer > a {
      position: absolute;
      color: transparent;
      text-decoration: none;
      display: block;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s ease;
      pointer-events: auto;
    }
    
    .linkLayer > a:hover {
      background: rgba(255, 193, 7, 0.3);
      border-color: rgba(255, 193, 7, 0.6);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .linkLayer > a:active {
      background: rgba(255, 193, 7, 0.5);
      transform: scale(0.98);
    }
    
    /* 모바일 터치 최적화 */
    @media (max-width: 768px) {
      .linkLayer > a {
        min-height: 44px;
        min-width: 44px;
      }
      
      .textLayer {
        font-size: 14px;
      }
      
      .linkLayer > a:hover {
        background: rgba(255, 193, 7, 0.4);
      }
    }
    
    /* 매우 작은 화면 */
    @media (max-width: 480px) {
      .textLayer {
        font-size: 12px;
      }
      
      .linkLayer > a {
        min-height: 48px;
        min-width: 48px;
      }
    }
    
    /* 로딩 인디케이터 */
    .loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 18px;
      color: #495057;
      z-index: 1000;
      text-align: center;
      background: rgba(255, 255, 255, 0.9);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .loading::after {
      content: '';
      display: block;
      width: 24px;
      height: 24px;
      border: 3px solid #dee2e6;
      border-radius: 50%;
      border-top-color: #007bff;
      animation: spin 1s linear infinite;
      margin: 10px auto 0;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* 스크롤바 스타일링 */
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
  </style>
</head>
<body>
  <div class="loading" id="loading">PDF 로딩 중...</div>
  <div id="pdf-container"></div>

  <!-- PDF.js 라이브러리 로드 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    const url = "wedding.pdf";
    const container = document.getElementById('pdf-container');
    const loading = document.getElementById('loading');
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // 화면 너비에 맞는 최적 스케일 계산
    function getOptimalScale() {
      const screenWidth = window.innerWidth;
      const dpr = window.devicePixelRatio || 1;
      
      // 고해상도 디스플레이를 고려한 스케일 조정
      if (screenWidth <= 480) return 1.5 * Math.min(dpr, 2);
      if (screenWidth <= 768) return 1.8 * Math.min(dpr, 2);
      return 2.2 * Math.min(dpr, 2);
    }

    // 뷰포트 크기에 맞춰 캔버스 크기 조정
    function adjustCanvasSize(canvas, viewport) {
      const screenWidth = window.innerWidth;
      const scale = screenWidth / viewport.width;
      
      canvas.style.width = screenWidth + 'px';
      canvas.style.height = (viewport.height * scale) + 'px';
      canvas.width = screenWidth * (window.devicePixelRatio || 1);
      canvas.height = viewport.height * scale * (window.devicePixelRatio || 1);
      
      return scale;
    }

    // URL 유효성 검사 및 정리
    function sanitizeUrl(url) {
      if (!url) return null;
      
      // 기본적인 URL 패턴 검사
      const urlPattern = /^(https?:\/\/|mailto:|tel:)/i;
      if (urlPattern.test(url)) {
        return url;
      }
      
      // HTTP가 없는 경우 추가
      if (url.includes('.') && !url.startsWith('javascript:')) {
        return 'https://' + url;
      }
      
      return null;
    }

    pdfjsLib.getDocument(url).promise.then(pdf => {
      loading.style.display = 'none';
      
      const renderPage = num => {
        pdf.getPage(num).then(page => {
          const scale = getOptimalScale();
          const viewport = page.getViewport({ scale: scale });
          
          // 페이지 컨테이너 생성
          const pageContainer = document.createElement("div");
          pageContainer.className = "page-container";
          pageContainer.setAttribute('data-page-number', num);
          pageContainer.id = 'page-' + num;
          container.appendChild(pageContainer);

          // 캔버스 생성
          const canvas = document.createElement("canvas");
          const context = canvas.getContext("2d");
          pageContainer.appendChild(canvas);
          
          // 캔버스 크기를 화면에 맞게 조정
          const displayScale = adjustCanvasSize(canvas, viewport);
          
          // 페이지 컨테이너 높이 설정
          pageContainer.style.height = canvas.style.height;

          // 텍스트 레이어 생성
          const textLayerDiv = document.createElement("div");
          textLayerDiv.className = "textLayer";
          textLayerDiv.style.width = canvas.style.width;
          textLayerDiv.style.height = canvas.style.height;
          pageContainer.appendChild(textLayerDiv);

          // 링크 레이어 생성
          const linkLayerDiv = document.createElement("div");
          linkLayerDiv.className = "linkLayer";
          linkLayerDiv.style.width = canvas.style.width;
          linkLayerDiv.style.height = canvas.style.height;
          pageContainer.appendChild(linkLayerDiv);

          // 고해상도 렌더링을 위한 컨텍스트 스케일링
          const outputScale = window.devicePixelRatio || 1;
          context.scale(outputScale, outputScale);

          const renderContext = {
            canvasContext: context,
            viewport: page.getViewport({ scale: scale * displayScale })
          };

          // 페이지 렌더링
          const renderTask = page.render(renderContext);
          
          // 텍스트 콘텐츠와 링크 가져오기
          const textContent = page.getTextContent();
          const annotations = page.getAnnotations();

          Promise.all([renderTask.promise, textContent, annotations]).then(([_, textContent, annotations]) => {
            // 텍스트 레이어 렌더링 (화면 크기에 맞춰 스케일 조정)
            const textViewport = page.getViewport({ scale: scale * displayScale });
            
            try {
              pdfjsLib.renderTextLayer({
                textContentSource: textContent,
                container: textLayerDiv,
                viewport: textViewport,
                textDivs: []
              });
            } catch (error) {
              console.warn('Text layer rendering failed:', error);
            }

            // 개선된 링크 레이어 생성
            annotations.forEach((annotation, index) => {
              if (annotation.subtype === 'Link') {
                const link = document.createElement('a');
                
                // URL 처리 개선
                let linkUrl = null;
                if (annotation.url) {
                  linkUrl = sanitizeUrl(annotation.url);
                } else if (annotation.action && annotation.action.url) {
                  linkUrl = sanitizeUrl(annotation.action.url);
                }
                
                if (linkUrl) {
                  link.href = linkUrl;
                  link.target = '_blank';
                  link.rel = 'noopener noreferrer';
                  
                  // 링크 클릭 이벤트 추가
                  link.addEventListener('click', function(e) {
                    // 터치 디바이스에서 더블 탭 방지
                    if ('ontouchstart' in window) {
                      e.preventDefault();
                      window.open(linkUrl, '_blank', 'noopener,noreferrer');
                    }
                  });
                } else if (annotation.dest) {
                  // 내부 링크 처리
                  link.href = '#page-' + annotation.dest;
                  link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetPage = document.getElementById('page-' + annotation.dest);
                    if (targetPage) {
                      targetPage.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                  });
                } else {
                  // 링크가 없는 경우 스킵
                  return;
                }
                
                // 링크 위치 및 크기 계산
                const rect = annotation.rect;
                const linkScale = displayScale;
                
                link.style.position = 'absolute';
                link.style.left = (rect[0] * linkScale) + 'px';
                link.style.top = ((textViewport.height - rect[3] * scale) * displayScale / scale) + 'px';
                link.style.width = ((rect[2] - rect[0]) * linkScale) + 'px';
                link.style.height = ((rect[3] - rect[1]) * linkScale) + 'px';
                link.style.display = 'block';
                link.style.color = 'transparent';
                link.style.textDecoration = 'none';
                link.style.cursor = 'pointer';
                link.style.zIndex = '20';
                
                // 접근성을 위한 속성 추가
                link.setAttribute('aria-label', '링크: ' + (linkUrl || '내부 링크'));
                link.setAttribute('data-link-index', index);
                
                // 터치 디바이스를 위한 최소 크기 보장
                if ('ontouchstart' in window) {
                  const minSize = 44;
                  const currentWidth = parseFloat(link.style.width);
                  const currentHeight = parseFloat(link.style.height);
                  
                  if (currentWidth < minSize) {
                    link.style.width = minSize + 'px';
                    const leftOffset = (minSize - currentWidth) / 2;
                    link.style.left = (parseFloat(link.style.left) - leftOffset) + 'px';
                  }
                  
                  if (currentHeight < minSize) {
                    link.style.height = minSize + 'px';
                    const topOffset = (minSize - currentHeight) / 2;
                    link.style.top = (parseFloat(link.style.top) - topOffset) + 'px';
                  }
                }
                
                linkLayerDiv.appendChild(link);
              }
            });
            
            // 다음 페이지 렌더링
            if (num < pdf.numPages) {
              renderPage(num + 1);
            }
          }).catch(error => {
            console.error('Error rendering page content:', error);
            // 다음 페이지 렌더링 계속 진행
            if (num < pdf.numPages) {
              renderPage(num + 1);
            }
          });
        }).catch(error => {
          console.error('Error loading page:', error);
          // 다음 페이지 렌더링 계속 진행
          if (num < pdf.numPages) {
            renderPage(num + 1);
          }
        });
      };
      
      renderPage(1);
    }).catch(error => {
      console.error('Error loading PDF:', error);
      loading.innerHTML = 'PDF 로딩 실패<br><small>파일을 확인해주세요.</small>';
      loading.style.color = '#dc3545';
    });

    // 화면 크기 변경 시 재렌더링 (디바운싱 적용)
    let resizeTimeout;
    window.addEventListener('resize', function() {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(function() {
        // 화면 방향 변경이나 크기 변경 시에만 새로고침
        const currentWidth = window.innerWidth;
        if (Math.abs(currentWidth - (window.lastWidth || currentWidth)) > 50) {
          window.lastWidth = currentWidth;
          location.reload();
        }
      }, 500);
    });

    // 초기 화면 너비 저장
    window.lastWidth = window.innerWidth;

    // 터치 스크롤 최적화
    let isScrolling = false;
    let touchStartY = 0;
    
    document.addEventListener('touchstart', function(e) {
      isScrolling = true;
      touchStartY = e.touches[0].clientY;
    }, { passive: true });
    
    document.addEventListener('touchmove', function(e) {
      if (isScrolling) {
        const touchCurrentY = e.touches[0].clientY;
        const deltaY = touchStartY - touchCurrentY;
        
        // 수평 스크롤 방지
        if (Math.abs(deltaY) < 10) {
          e.preventDefault();
        }
      }
    }, { passive: false });
    
    document.addEventListener('touchend', function() {
      setTimeout(function() {
        isScrolling = false;
      }, 100);
    }, { passive: true });

    // 키보드 네비게이션 지원
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Home') {
        window.scrollTo({ top: 0, behavior: 'smooth' });
        e.preventDefault();
      } else if (e.key === 'End') {
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        e.preventDefault();
      }
    });
  </script>
</body>
</html>

